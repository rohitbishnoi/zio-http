<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<title data-react-helmet="true">Middleware | ZIO-HTTP</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://github.com/dream11/zio-http/docs/v1.x/dsl/middleware"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Middleware | ZIO-HTTP"><meta data-react-helmet="true" name="description" content="What is a &quot;Middleware&quot;?"><meta data-react-helmet="true" property="og:description" content="What is a &quot;Middleware&quot;?"><link data-react-helmet="true" rel="canonical" href="https://github.com/dream11/zio-http/docs/v1.x/dsl/middleware"><link data-react-helmet="true" rel="alternate" href="https://github.com/dream11/zio-http/docs/v1.x/dsl/middleware" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://github.com/dream11/zio-http/docs/v1.x/dsl/middleware" hreflang="x-default"><link rel="stylesheet" href="/zio-http/assets/css/styles.c2d7348c.css">
<link rel="preload" href="/zio-http/assets/js/runtime~main.72c0bca7.js" as="script">
<link rel="preload" href="/zio-http/assets/js/main.2b6fecb1.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zio-http/"><b class="navbar__title">ZIO-HTTP</b></a><a class="navbar__item navbar__link navbar__link--active" href="/zio-http/docs/v1.x/index">Tutorial</a></div><div class="navbar__items navbar__items--right"><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">v1.x</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/docs/v1.x/index">Setup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/docs/v1.x/getting-started">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">DSL</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/docs/v1.x/dsl/server">Server</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/docs/v1.x/dsl/http">Http</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/docs/v1.x/dsl/request">Request</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/docs/v1.x/dsl/response">Response</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/docs/v1.x/dsl/httpdata">HttpData</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/docs/v1.x/dsl/headers">Headers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/docs/v1.x/dsl/cookies">Cookie</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/zio-http/docs/v1.x/dsl/middleware">Middleware</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Socket</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Client</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Testing</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Integrations</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Examples</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Middleware</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="what-is-a-middleware">What is a &quot;Middleware&quot;?<a aria-hidden="true" class="hash-link" href="#what-is-a-middleware" title="Direct link to heading">â€‹</a></h2><p>Before introducing middleware, let us understand why they are needed.</p><p>Consider the following example where we have two endpoints within HttpApp</p><ul><li>GET a single user by id</li><li>GET all users</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  private val app = Http.collectZIO[Request] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case Method.GET -&gt; !! / &quot;users&quot; / id =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // core business logic  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dbService.lookupUsersById(id).map(Response.json(_.json))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case Method.GET -&gt; !! / &quot;users&quot;    =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // core business logic  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dbService.paginatedUsers(pageNum).map(Response.json(_.json))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="the-polluted-code-violates-the-principle-of-separation-of-concerns">The polluted code violates the principle of &quot;Separation of concerns&quot;<a aria-hidden="true" class="hash-link" href="#the-polluted-code-violates-the-principle-of-separation-of-concerns" title="Direct link to heading">â€‹</a></h4><p>As our application grows, we want to code the following aspects like</p><ul><li>Basic Auth</li><li>Request logging</li><li>Response logging</li><li>Timeout and retry</li></ul><p>For both of our example endpoints, our core business logic gets buried under boilerplate like this</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">            (for {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // validate user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                _    &lt;- MyAuthService.doAuth(request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // log request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                _    &lt;- logRequest(request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // core business logic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                user &lt;- dbService.lookupUsersById(id).map(Response.json(_.json))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                resp &lt;- Response.json(user.toJson)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // log response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                _    &lt;- logResponse(resp)                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } yield resp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .timeout(2.seconds)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .retryN(5)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Imagine repeating this for all our endpoints!!!</p><p>So there are two problems with this approach</p><ul><li>We are dangerously coupling our business logic with cross-cutting concerns (like applying timeouts)</li><li>Also, addressing these concerns will require updating code for every single route in the system. For 100 routes we will need to repeat 100 timeouts!!!</li><li>For example, any change related to a concern like the logging mechanism from logback to log4j2 may cause changing signature of <code>log(..)</code> function in 100 places.</li><li>On the other hand, this also makes testing core business logic more cumbersome.</li></ul><p>This can lead to a lot of boilerplate clogging our neatly written endpoints affecting readability, thereby leading to increased maintenance costs.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="need-for-middlewares-and-handling-aspects">Need for middlewares and handling &quot;aspects&quot;<a aria-hidden="true" class="hash-link" href="#need-for-middlewares-and-handling-aspects" title="Direct link to heading">â€‹</a></h2><p>If we refer to Wikipedia for the definition of an &quot;<a href="https://en.wikipedia.org/wiki/Aspect_(computer_programming)" target="_blank" rel="noopener noreferrer">Aspect</a>&quot; we can glean the following points.</p><ul><li>An aspect of a program is a feature linked to many other parts of the program (<strong><em>most common example, logging</em></strong>)., </li><li>But it is not related to the program&#x27;s primary function (<strong><em>core business logic</em></strong>) </li><li>An aspect crosscuts the program&#x27;s core concerns (<strong><em>for example logging code intertwined with core business logic</em></strong>),  </li><li>Therefore, it can violate the principle of &quot;separation of concerns&quot; which tries to encapsulate unrelated functions. (<strong><em>Code duplication and maintenance nightmare</em></strong>)</li></ul><p>Or in short, aspect is a common concern required throughout the application, and its implementation could lead to repeated boilerplate code and in violation of the principle of separation of concerns.
There is a paradigm in the programming world called <a href="https://en.wikipedia.org/wiki/Aspect-oriented_programming" target="_blank" rel="noopener noreferrer">aspect-oriented programming</a> that aims for modular handling of these common concerns in an application. </p><p>Some examples of common &quot;aspects&quot; required throughout the application</p><ul><li>logging,</li><li>timeouts (preventing long-running code)</li><li>retries (or handling flakiness for example while accessing third party APIs)</li><li>authenticating a user before using the REST resource (basic, or custom ones like OAuth / single sign-on, etc).</li></ul><p>This is where middleware comes to the rescue.
Using middlewares we can compose out-of-the-box middlewares (or our custom middlewares) to address the above-mentioned concerns using ++ and @@ operators as shown below.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="cleaned-up-code-using-middleware-to-address-cross-cutting-concerns-like-auth-requestresponse-logging-etc">Cleaned up code using middleware to address cross-cutting concerns like auth, request/response logging, etc.<a aria-hidden="true" class="hash-link" href="#cleaned-up-code-using-middleware-to-address-cross-cutting-concerns-like-auth-requestresponse-logging-etc" title="Direct link to heading">â€‹</a></h4><p>Observe, how we can address multiple cross-cutting concerns using neatly composed middlewares, in a single place.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// compose basic auth, request/response logging, timeouts middlewares</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val composedMiddlewares = Middleware.basicAuth(&quot;user&quot;,&quot;pw&quot;) ++ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Middleware.debug ++ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Middleware.timeout(5 seconds) </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>And then we can attach our composed bundle of middlewares to an Http using <code>@@</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private val app = Http.collectZIO[Request] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case Method.GET -&gt; !! / &quot;users&quot; / id =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // core business logic  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dbService.lookupUsersById(id).map(Response.json(_.json))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case Method.GET -&gt; !! / &quot;users&quot;    =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // core business logic  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dbService.paginatedUsers(pageNum).map(Response.json(_.json))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} @@ composedMiddlewares // attach composedMiddlewares to the app using @@</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Observe how we gained the following benefits by using middlewares</p><ul><li><strong>Readability</strong>: de-cluttering business logic.</li><li><strong>Modularity</strong>: we can manage aspects independently without making changes in 100 places. For example, <ul><li>replacing the logging mechanism from logback to log4j2 will require a change in one place, the logging middleware.</li><li>replacing the authentication mechanism from OAuth to single sign-on will require changing the auth middleware</li></ul></li><li><strong>Testability</strong>: we can test our aspects independently.</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="middleware-in-zio-http">Middleware in zio-http<a aria-hidden="true" class="hash-link" href="#middleware-in-zio-http" title="Direct link to heading">â€‹</a></h2><p>A middleware helps in addressing common crosscutting concerns without duplicating boilerplate code.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="revisiting-http">Revisiting HTTP<a aria-hidden="true" class="hash-link" href="#revisiting-http" title="Direct link to heading">â€‹</a></h4><p><a href="https://dream11.github.io/zio-http/docs/v1.x/dsl/http" target="_blank" rel="noopener noreferrer"><code>Http</code></a> is the most fundamental type for modeling Http applications</p><p><code>Http[-R, +E, -A, +B]</code> is equivalent to <code>(A) =&gt; ZIO[R, Option[E], B]</code> where</p><ul><li><code>R</code> type of Environment </li><li><code>E</code> type of the Error when the function fails with Some<!-- -->[E]</li><li><code>A</code> is the type of input given to the Http</li><li><code>B</code> type of the output produced by the Http </li></ul><p>Middleware is simply a function that takes one <code>Http</code> as a parameter and returns a new <code>Http</code> with some enhanced capabilities.,</p><p><code>Http =&gt; Http</code></p><p>So, a middleware represents function transformation f1 =&gt; f2</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">type Middleware[R, E, AIn, BIn, AOut, BOut] = Http[R, E, AIn, BIn] =&gt; Http[R, E, AOut, BOut]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><code>AIn</code> and <code>BIn</code> are type params of the input <code>Http</code></li><li><code>AOut</code> and <code>BOut</code> are type params of the output <code>Http</code></li></ul><p><strong>HttpApp</strong> is a specialized Http with <code>Request</code> and <code>Response</code> as input and output</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">type HttpApp[-R,+E] = Http[R, E, Request, Response]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the  <code>HttpApp</code> context, a middleware can modify requests and responses and also transform them into more concrete domain entities.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="attaching-middleware-to-http">Attaching middleware to Http<a aria-hidden="true" class="hash-link" href="#attaching-middleware-to-http" title="Direct link to heading">â€‹</a></h4><p><code>@@</code> operator is used to attach a middleware to an Http. Example below shows a middleware attached to an HttpApp</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val app = Http.collect[Request] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case Method.GET -&gt; !! / name =&gt; Response.text(s&quot;Hello $name&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val appWithMiddleware = app @@ Middleware.debug</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Logically the code above translates to <code>Middleware.debug(app)</code></p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="a-simple-middleware-example">A simple middleware example<a aria-hidden="true" class="hash-link" href="#a-simple-middleware-example" title="Direct link to heading">â€‹</a></h4><p>Let us consider a simple example using out-of-the-box middleware called <code>addHeader</code>
We will write a middleware that will attach a custom header to the response. </p><p>Start with imports</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">import zhttp.http._</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import zhttp.service.Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import zio.console.{putStrLn}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import zio.{App, ExitCode, URIO}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>We create a middleware that appends an additional header to the response indicating whether it is a Dev/Prod/Staging environment.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">lazy val patchEnv = Middleware.addHeader(&quot;X-Environment&quot;, &quot;Dev&quot;)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>A test HttpApp with attached middleware</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val app = Http.collect[Request] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case Method.GET -&gt; !! / name =&gt; Response.text(s&quot;Hello $name&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val appWithMiddleware = app @@ patchEnv</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Start the server </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val server = Server.start(8090, appWithMiddleware).exitCode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zio.Runtime.default.unsafeRunSync(server)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Fire a curl request and we see an additional header added to the response indicating the &quot;Dev&quot; environment</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">curl -i http://localhost:8090/Bob</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 200 OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">content-type: text/plain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">X-Environment: Dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">content-length: 12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello Bob</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="advanced-example-showing-the-transformative-power-of-a-middleware-optional">Advanced example showing the transformative power of a middleware (Optional)<a aria-hidden="true" class="hash-link" href="#advanced-example-showing-the-transformative-power-of-a-middleware-optional" title="Direct link to heading">â€‹</a></h3><details class="details_Q743 alert alert--info details_h+cY" data-collapsed="true"><summary>Here is a slightly longer example to explore how powerful middleware transformation can be. It shows<ul><li>How we can define a service purely in terms of our domain types</li><li>Define a &quot;codec&quot; middleware for decoding requests and encoding responses to and from domain types</li><li>Transform our regular `Http` service to an HttpApp by applying our codec middleware</li></ul><b><i>Note: In real life, we will be using REST endpoints for defining routes. Although you can skip this section, this example gives a deeper insight into middleware.</i></b></summary><div><div class="collapsibleContent_K5uX"><p>Start with imports</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">import zhttp.http.{Http, HttpError, Middleware, Request, Response}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import zio.{ExitCode, URIO, ZEnv, ZIO}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import zio.json._</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import zhttp.service._</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Define some &quot;User&quot; domain types</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">final case class User(name: String, email: String, id: String)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">object User {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  implicit val codec: JsonCodec[User] = DeriveJsonCodec.gen[User]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sealed trait UsersRequest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">object UsersRequest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final case class Get(id: Int)                        extends UsersRequest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final case class Create(name: String, email: String) extends UsersRequest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  implicit val decoder: JsonDecoder[UsersRequest] = DeriveJsonDecoder.gen[UsersRequest]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sealed trait UsersResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">object UsersResponse {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final case class Got(user: User)     extends UsersResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final case class Created(user: User) extends UsersResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  implicit val encoder: JsonEncoder[UsersResponse] = DeriveJsonEncoder.gen[UsersResponse]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Define a Users service <em><strong>purely in terms of our types</strong></em></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  val usersService: Http[Any, Nothing, UsersRequest, UsersResponse] = Http.collect {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case UsersRequest.Create(name, email) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      UsersResponse.Created(User(name, email, &quot;abc123&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case UsersRequest.Get(id)             =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      UsersResponse.Got(User(id.toString, &quot;&quot;, &quot;&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>A codec middleware which transforms an <code>Http</code> with different input/output types to <code>HttpApp</code> with <strong>Request and Response</strong></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  def codecMiddleware[In: JsonDecoder, Out: JsonEncoder]: Middleware[Any,Nothing,In,Out,Request,Response] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Middleware.codecZIO[Request,Out](</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // deserialize the request into In type or fail with some message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      request =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          body &lt;- request.getBodyAsString</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          in   &lt;- ZIO.fromEither(JsonDecoder[In].decodeJson(body))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } yield in,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      out =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          charSeq &lt;- ZIO(JsonEncoder[Out].encodeJson(out, None))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } yield Response.json(charSeq.toString)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) &lt;&gt; Middleware.succeed(Response.fromHttpError(HttpError.BadRequest(&quot;Invalid JSON&quot;)))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Let us transform our regular Http with UserService to an HttpApp using our codec middleware</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val transformedHttpApp: Http[Any, Nothing, Request, Response] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    usersService @@ codecMiddleware[UsersRequest,UsersResponse]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Just observe how our service <code>Http</code> got transformed to <code>HttpApp</code> by applying middleware</p><p><code>Http[Any, Nothing, UsersRequest, UsersResponse]</code> ===&gt; <code>Http[Any, Nothing, Request, Response]</code> (HttpApp)</p><p>Start the server</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val server = Server.start(8090, transformedHttpApp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zio.Runtime.default.unsafeRunSync(server)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Fire a curl request along with the request body</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">curl -i -d &#x27;{ &quot;Create&quot;:{ &quot;name&quot;:&quot;Sum&quot;, &quot;email&quot;: &quot;s@d1.com&quot; }}&#x27; http://localhost:8090/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Observe the response</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 200 OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">content-type: application/json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">content-length: 68</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;Created&quot;:{&quot;user&quot;:{&quot;name&quot;:&quot;Sum&quot;,&quot;email&quot;:&quot;s@d1.com&quot;,&quot;id&quot;:&quot;abc123&quot;}}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div></div></details><h2 class="anchor anchorWithStickyNavbar_y2LR" id="creating-middleware">Creating Middleware<a aria-hidden="true" class="hash-link" href="#creating-middleware" title="Direct link to heading">â€‹</a></h2><p>Refer to <a href="https://github.com/dream11/zio-http/blob/main/zio-http/src/main/scala/zhttp/http/Middleware.scala" target="_blank" rel="noopener noreferrer">Middleware.scala</a> for various ways of creating a middleware.</p><p>Again remember that a &quot;middleware&quot; is just a <strong><em>transformative function</em></strong>. There are ways of creating such transformative functions:  </p><ul><li><strong>identity</strong>: works like an <a href="https://en.wikipedia.org/wiki/Identity_function" target="_blank" rel="noopener noreferrer">identity function</a> in mathematics
<code>f(x) = x</code>.
It returns the same <code>Http</code> as input without doing any modification</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val identityMW: Middleware[Any, Nothing, Nothing, Any, Any, Nothing] = Middleware.identity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app @@ identityMW // no effect on the http app.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><strong>succeed</strong> creates a middleware that always returns the output <code>Http</code> that succeeds with the given value and never fails.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val middleware: Middleware[Any, Nothing, Nothing, Any, Any, Int] = Middleware.succeed(1)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><strong>fail</strong> creates a middleware that always returns the output <code>Http</code> that always fails.</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val middleware: Middleware[Any, String, Nothing, Any, Any, Nothing] = Middleware.fail(&quot;error&quot;)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><strong>collect</strong> creates middleware using a specified function</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val middleware: Middleware[Any, Nothing, Request, Response, Request, Response] = Middleware.collect[Request](_ =&gt; Middleware.addHeaders(Headers(&quot;a&quot;, &quot;b&quot;)))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><strong>collectZIO</strong> creates middleware using a specified effect function</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val middleware: Middleware[Any, Nothing, Request, Response, Request, Response] = Middleware.collectZIO[Request](_ =&gt; ZIO.succeed(Middleware.addHeaders(Headers(&quot;a&quot;, &quot;b&quot;))))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><strong>codec</strong> takes two functions <code>decoder: AOut =&gt; Either[E, AIn]</code> and <code>encoder: BIn =&gt; Either[E, BOut]</code></li></ul><p>The below snippet takes two functions:</p><ul><li>decoder function to decode Request to String</li><li>encoder function to encode String to Response</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val middleware: Middleware[Any, Nothing, String, String, Request, Response] = Middleware.codec[Request,String](r =&gt; Right(r.method.toString()), s =&gt; Right(Response.text(s)))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><strong>fromHttp</strong> creates a middleware with output <code>Http</code> as specified <code>http</code></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val app: Http[Any, Nothing, Any, String] = Http.succeed(&quot;Hello World!&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val middleware: Middleware[Any, Nothing, Nothing, Any, Request, Response] = Middleware.fromHttp(app)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="combining-middlewares">Combining middlewares<a aria-hidden="true" class="hash-link" href="#combining-middlewares" title="Direct link to heading">â€‹</a></h2><p>Middlewares can be combined using several special operators like <code>++</code>, <code>&lt;&gt;</code> and <code>&gt;&gt;&gt;</code></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="using--combinator">Using <code>++</code> combinator<a aria-hidden="true" class="hash-link" href="#using--combinator" title="Direct link to heading">â€‹</a></h3><p><code>++</code> is an alias for <code>combine</code>. It combines two middlewares <strong><em>without changing their input/output types (<code>AIn</code> = <code>AOut</code> / <code>BIn</code> = <code>BOut</code>)</em></strong></p><p>For example, if we have three middlewares f1, f2, f3</p><p>f1 ++ f2 ++ f3 applies on an <code>http</code>, from left to right with f1 first followed by others, like this </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">  f3(f2(f1(http)))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="a-simple-example-using--combinator">A simple example using <code>++</code> combinator<a aria-hidden="true" class="hash-link" href="#a-simple-example-using--combinator" title="Direct link to heading">â€‹</a></h4><p>Start with imports</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">import zhttp.http.Middleware.basicAuth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import zhttp.http._</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import zhttp.service.Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import zio.console.putStrLn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import zio.{App, ExitCode, URIO}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>A user app with single endpoint that welcomes a user</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val userApp: UHttpApp = Http.collect[Request] { case Method.GET -&gt; !! / &quot;user&quot; / name / &quot;greet&quot; =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Response.text(s&quot;Welcome to the ZIO party! ${name}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>A basicAuth middleware with hardcoded user pw and another patches response with environment value </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val basicAuthMW = basicAuth(&quot;admin&quot;, &quot;admin&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lazy val patchEnv = Middleware.addHeader(&quot;X-Environment&quot;, &quot;Dev&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// apply combined middlewares to the userApp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val appWithMiddleware = userApp @@ (basicAuthMW ++ patchEnv)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Start the server</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val server = Server.start(8090, appWithMiddleware).exitCode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zio.Runtime.default.unsafeRunSync(server)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Fire a curl request with an incorrect user/password combination</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">curl -i --user admin:wrong http://localhost:8090/user/admin/greet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 401 Unauthorized</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-authenticate: Basic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">X-Environment: Dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">content-length: 0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>We notice in the response that first basicAuth middleware responded <code>HTTP/1.1 401 Unauthorized</code> and then patch middleware attached a <code>X-Environment: Dev</code> header. </p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="using-">Using <code>&gt;&gt;&gt;</code><a aria-hidden="true" class="hash-link" href="#using-" title="Direct link to heading">â€‹</a></h3><p><code>&gt;&gt;&gt;</code> is an alias for <code>andThen</code> and similar to <code>++</code> with one BIG difference <strong><em>input/output types can be different (<code>AIn</code>â‰  <code>AOut</code> / <code>BIn</code>â‰  <code>BOut</code>)</em></strong><br>
<!-- -->Whereas, in the case of <code>++</code> types remain the same (horizontal composition).</p><p>For example, if we have three middlewares f1, f2, f3</p><p>f1 &gt;&gt;&gt; f2 &gt;&gt;&gt; f3 applies on an <code>http</code>, sequentially feeding an http to f1 first followed by f2 and f3.</p><p>f1(http) =&gt; http1
f2(http1) =&gt; http2</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="using--combinator-1">Using <code>&lt;&gt;</code> combinator<a aria-hidden="true" class="hash-link" href="#using--combinator-1" title="Direct link to heading">â€‹</a></h3><p><code>&lt;&gt;</code> is an alias for <code>orElse</code>. While using <code>&lt;&gt;</code>, if the output <code>Http</code> of the first middleware fails, the second middleware will be evaluated, ignoring the result from the first.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="a-simple-example-using-">A simple example using <code>&lt;&gt;</code><a aria-hidden="true" class="hash-link" href="#a-simple-example-using-" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val middleware: Middleware[Any, Nothing, Request, Response, Request, Response] = Middleware.fail(&quot;error&quot;) &lt;&gt; Middleware.addHeader(&quot;X-Environment&quot;, &quot;Dev&quot;)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="other-operators">other operators<a aria-hidden="true" class="hash-link" href="#other-operators" title="Direct link to heading">â€‹</a></h4><ul><li><p><strong>contraMap</strong>,<strong>contraMapZIO</strong>,<strong>delay</strong>,<strong>flatMap</strong>,<strong>flatten</strong>,<strong>map</strong>: which are obvious as their name implies.</p></li><li><p><strong>race</strong> to race middlewares</p></li><li><p><strong>runAfter</strong> and <strong>runBefore</strong> to run effect before and after</p></li><li><p><strong>when</strong> to conditionally run a middleware (input of output Http meets some criteria)</p></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="transforming-middlewares-some-advanced-examples">Transforming Middlewares (some advanced examples)<a aria-hidden="true" class="hash-link" href="#transforming-middlewares-some-advanced-examples" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="transforming-the-output-of-the-output-http">Transforming the output of the output <code>Http</code><a aria-hidden="true" class="hash-link" href="#transforming-the-output-of-the-output-http" title="Direct link to heading">â€‹</a></h3><ul><li>We can use <code>flatMap</code> or  <code>map</code> or <code>mapZIO</code> for transforming the output type of output Http</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val middleware: Middleware[Any, Nothing, Nothing, Any, Any, Int] = Middleware.succeed(3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val mid1: Middleware[Any, Nothing, Nothing, Any, Any, String] = middleware.map((i: Int) =&gt; i.toString)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val mid2: Middleware[Any, Nothing, Nothing, Any, Any, String] = middleware.mapZIO((i: Int) =&gt; ZIO.succeed(s&quot;$i&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val mid3: Middleware[Any, Nothing, Nothing, Any, Any, String] = middleware.flatMap((m: Int) =&gt; Middleware.succeed(m.toString))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>We can use <code>intercept</code> or <code>interceptZIO</code> to create a new middleware using transformation functions, which changes the output type of the output <code>Http</code> keeping input the same.</p><p>The below snippet takes two functions:</p><ul><li>(incoming: A =&gt; S)</li><li>(outgoing: (B, S) =&gt; BOut) </li></ul></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val middleware: Middleware[Any, Nothing, String, String, String, Int] = Middleware.intercept[String, String](_.toInt + 2)((_, a) =&gt; a + 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val mid: Middleware[Any, Nothing, Int, Int, Int, Int] = Middleware.interceptZIO[Int, Int](i =&gt; UIO(i * 10))((i, j) =&gt; UIO(i + j))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="transforming-the-input-of-the-output-http">Transforming the Input of the output <code>Http</code><a aria-hidden="true" class="hash-link" href="#transforming-the-input-of-the-output-http" title="Direct link to heading">â€‹</a></h3><p>We can use <code>contramap</code> or <code>contramapZIO</code> for transforming the input type of the output <code>Http</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val middleware: Middleware[Any, Nothing, Int, Int, Int, Int] = Middleware.codec[Int, Int](decoder = a =&gt; Right(a + 1), encoder = b =&gt; Right(b + 1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val mid1: Middleware[Any, Nothing, Int, Int, String, Int] = middleware.contramap[String](_.toInt)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val mid2: Middleware[Any, Nothing, Int, Int, String, Int] = middleware.contramapZIO[String](a =&gt; UIO(a.toInt))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="conditional-application-of-middlewares">Conditional application of middlewares<a aria-hidden="true" class="hash-link" href="#conditional-application-of-middlewares" title="Direct link to heading">â€‹</a></h2><ul><li><code>when</code> applies middleware only if the condition function evaluates to true</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val middleware: Middleware[Any, Nothing, Nothing, Any, Any, String] = Middleware.succeed(&quot;yes&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val mid: Middleware[Any, Nothing, Nothing, Any, String, String] = middleware.when[String]((str: String) =&gt; str.length &gt; 2)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>-<code>whenZIO</code> applies middleware only if the condition function(with effect) evaluates</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val middleware: Middleware[Any, Nothing, Nothing, Any, Any, String] = Middleware.succeed(&quot;yes&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val mid: Middleware[Any, Nothing, Nothing, Any, String, String] = middleware.whenZIO[Any, Nothing, String]((str: String) =&gt; UIO(str.length &gt; 2))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Logical operators to decide which middleware to select based on the predicate:</p><ul><li>Using <code>ifThenElse</code> </li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val mid: Middleware[Any, Nothing, Nothing, Any, Int, Int] = Middleware.ifThenElse[Int](_ &gt; 5)(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    isTrue = i =&gt; Middleware.succeed(i + 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    isFalse = i =&gt; Middleware.succeed(i - 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  )</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Using <code>ifThenElseZIO</code> </li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">val mid: Middleware[Any, Nothing, Nothing, Any, Int, Int] = Middleware.ifThenElseZIO[Int](i =&gt; UIO(i &gt; 5))(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    isTrue = i =&gt; Middleware.succeed(i + 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    isFalse = i =&gt; Middleware.succeed(i - 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  )</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="a-complete-example-of-a-middleware">A complete example of a middleware<a aria-hidden="true" class="hash-link" href="#a-complete-example-of-a-middleware" title="Direct link to heading">â€‹</a></h2><details class="details_Q743 alert alert--info details_h+cY" data-collapsed="true"><summary><b>Detailed example showing &quot;debug&quot; and &quot;addHeader&quot; middlewares</b></summary><div><div class="collapsibleContent_K5uX"><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI scala"><pre tabindex="0" class="prism-code language-scala codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    import zhttp.http._</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    import zhttp.http.middleware.HttpMiddleware</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    import zhttp.service.Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    import zio.clock.{Clock, currentTime}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    import zio.console.Console</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    import zio.duration._</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    import zio.{App, ExitCode, URIO, ZIO}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    import java.io.IOException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    import java.util.concurrent.TimeUnit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     val app: HttpApp[Clock, Nothing] = Http.collectZIO[Request] {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       // this will return result instantly</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       case Method.GET -&gt; !! / &quot;text&quot;         =&gt; ZIO.succeed(Response.text(&quot;Hello World!&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       // this will return result after 5 seconds, so with 3 seconds timeout it will fail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       case Method.GET -&gt; !! / &quot;long-running&quot; =&gt; ZIO.succeed(Response.text(&quot;Hello World!&quot;)).delay(5 seconds)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val middlewares: HttpMiddleware[Console with Clock, IOException] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       // print debug info about request and response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       Middleware.debug ++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       // add static header</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       Middleware.addHeader(&quot;X-Environment&quot;, &quot;Dev&quot;) ++   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   override def run(args: List[String]): URIO[zio.ZEnv, ExitCode] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       Server.start(8090, (app @@ middlewares)).exitCode</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div></div></details><h3 class="anchor anchorWithStickyNavbar_y2LR" id="a-few-out-of-the-box-middlewares">A few &quot;Out of the box&quot; middlewares<a aria-hidden="true" class="hash-link" href="#a-few-out-of-the-box-middlewares" title="Direct link to heading">â€‹</a></h3><ul><li><a href="https://dream11.github.io/zio-http/docs/v1.x/examples/advanced-examples/middleware_basic_auth" target="_blank" rel="noopener noreferrer">Basic Auth</a> </li><li><a href="https://dream11.github.io/zio-http/docs/v1.x/examples/advanced-examples/middleware_cors" target="_blank" rel="noopener noreferrer">CORS</a></li><li><a href="https://dream11.github.io/zio-http/docs/v1.x/examples/advanced-examples/middleware_csrf" target="_blank" rel="noopener noreferrer">CSRF</a></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zio-http/docs/v1.x/dsl/cookies"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Cookie</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zio-http/docs/v1.x/dsl/socket/socket"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Socket<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-a-middleware" class="table-of-contents__link toc-highlight">What is a &quot;Middleware&quot;?</a></li><li><a href="#need-for-middlewares-and-handling-aspects" class="table-of-contents__link toc-highlight">Need for middlewares and handling &quot;aspects&quot;</a></li><li><a href="#middleware-in-zio-http" class="table-of-contents__link toc-highlight">Middleware in zio-http</a><ul><li><a href="#advanced-example-showing-the-transformative-power-of-a-middleware-optional" class="table-of-contents__link toc-highlight">Advanced example showing the transformative power of a middleware (Optional)</a></li></ul></li><li><a href="#creating-middleware" class="table-of-contents__link toc-highlight">Creating Middleware</a></li><li><a href="#combining-middlewares" class="table-of-contents__link toc-highlight">Combining middlewares</a><ul><li><a href="#using--combinator" class="table-of-contents__link toc-highlight">Using <code>++</code> combinator</a></li><li><a href="#using-" class="table-of-contents__link toc-highlight">Using <code>&gt;&gt;&gt;</code></a></li><li><a href="#using--combinator-1" class="table-of-contents__link toc-highlight">Using <code>&lt;&gt;</code> combinator</a></li></ul></li><li><a href="#transforming-middlewares-some-advanced-examples" class="table-of-contents__link toc-highlight">Transforming Middlewares (some advanced examples)</a><ul><li><a href="#transforming-the-output-of-the-output-http" class="table-of-contents__link toc-highlight">Transforming the output of the output <code>Http</code></a></li><li><a href="#transforming-the-input-of-the-output-http" class="table-of-contents__link toc-highlight">Transforming the Input of the output <code>Http</code></a></li></ul></li><li><a href="#conditional-application-of-middlewares" class="table-of-contents__link toc-highlight">Conditional application of middlewares</a></li><li><a href="#a-complete-example-of-a-middleware" class="table-of-contents__link toc-highlight">A complete example of a middleware</a><ul><li><a href="#a-few-out-of-the-box-middlewares" class="table-of-contents__link toc-highlight">A few &quot;Out of the box&quot; middlewares</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zio-http/docs/v1.x/index">Documents</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://discord.com/channels/629491597070827530/819703129267372113" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"></div></div></footer></div>
<script src="/zio-http/assets/js/runtime~main.72c0bca7.js"></script>
<script src="/zio-http/assets/js/main.2b6fecb1.js"></script>
</body>
</html>